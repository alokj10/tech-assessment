{"version":3,"sources":["../../src/utils/auth.js"],"names":["jwt","require","resources","resource","allowedRoles","undefined","isTokenExpired","decodedToken","isExpiredToken","dateNow","Date","getTime","console","log","exp","module","exports","req","res","next","token","headers","requestedPath","path","status","send","decoded","verify","AuthConfig","myPrivateKey","user","role","currentUserRole","currentResource","filter","item","index","length","includes","ex","TokenExpiredError","json","message"],"mappings":"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","file":"auth.js","sourcesContent":["const jwt = require(\"jsonwebtoken\");\r\nimport { AuthConfig } from '../commons/ServerConfig';\r\n\r\nconst resources = [\r\n    { \r\n        resource: '/admin/getAllMcqs',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/getMcqsBySkill',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/mcq',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/bulkMcq',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff' ] \r\n    },\r\n    { \r\n        resource: '/admin/getAllCategories',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/category',\r\n        allowedRoles: [ 'admin', 'recruiter' ] \r\n    },\r\n    { \r\n        resource: '/admin/getAllSkills',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/skill',\r\n        allowedRoles: [ 'admin', 'recruiter' ] \r\n    },\r\n    { \r\n        resource: '/candidate/sendInvite',\r\n        allowedRoles: [ 'admin', 'recruiter', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/getAllTests',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'candidate', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/getMyTests',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'candidate', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/getTest',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/test',\r\n        allowedRoles: [ 'admin', 'recruiter', 'staff', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/getAllUsers',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/user',\r\n        allowedRoles: [ 'admin', 'orgadmin' ] \r\n    },\r\n    { \r\n        resource: '/admin/getAllOrgs',\r\n        allowedRoles: [ 'admin', 'orgadmin' ] \r\n    },\r\n    { \r\n        resource: '/admin/org',\r\n        allowedRoles: [ 'admin' ] \r\n    },\r\n    { \r\n        resource: '/admin/getCandidatesByTestId',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/getMcqsByTestId',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/dashboard/test/count',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/dashboard/mcq/count',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/dashboard/invitation/count',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/candidate/startTest',\r\n        allowedRoles: [ 'admin', 'candidate' ] \r\n    },\r\n    {\r\n        resource: '/candidate/submitAnswers',\r\n        allowedRoles: [ 'admin', 'candidate' ]\r\n    },\r\n    {\r\n        resource: '/candidate/getAllInvites',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'teacher' ]\r\n    },\r\n    {\r\n        resource: '/candidate/evaluateAnswers',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'teacher' ]\r\n    },\r\n    {\r\n        resource: '/loadConfig',\r\n        allowedRoles: [ 'admin', 'orgadmin', null, undefined, '' ]\r\n    },\r\n    { \r\n        resource: '/admin/getCandidateResponseReport',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/getCandidateDetails',\r\n        allowedRoles: [ 'admin', 'orgadmin', 'staff', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/getAllGrades',\r\n        allowedRoles: [ 'admin', 'teacher' ] \r\n    },\r\n    { \r\n        resource: '/admin/grade',\r\n        allowedRoles: [ 'admin', 'teacher' ] \r\n    }\r\n];\r\n\r\nconst isTokenExpired = (decodedToken) => {\r\n    var isExpiredToken = false;\r\n    var dateNow = new Date().getTime() / 1000;\r\n    console.log(`now: ${dateNow}`);\r\n    console.log(`expiryTime: ${decodedToken.exp}`);\r\n    if(decodedToken && decodedToken.exp < dateNow)\r\n    {\r\n        console.log(`Token expired, expiry at: ${decodedToken.exp}`);\r\n        isExpiredToken = true;\r\n    }\r\n    return isExpiredToken;\r\n}\r\n\r\nmodule.exports = function(req, res, next) {\r\n    const token = req.headers[\"x-access-token\"] || req.headers[\"authorization\"];\r\n    const requestedPath = req.path;\r\n    console.log('requested path: ', requestedPath);\r\n    // console.log('auth middleware check', token);\r\n    if (!token || token === \"null\") {\r\n        console.log('token missing', token);\r\n        return res.status(401).send(\"Access denied. No token provided.\");\r\n    }\r\n    try {\r\n        //if can verify the token, set req.user and pass to next middleware\r\n        // console.log('verifying with token', token);\r\n        const decoded = jwt.verify(token, AuthConfig.myPrivateKey);\r\n        if(isTokenExpired(decoded)) {\r\n            return res.status(401).send(\"Token expired. Please login again.\");\r\n        }\r\n        req.user = decoded;\r\n        console.log('user: ', req.user);\r\n        if(req.user && req.user.role) {\r\n            let currentUserRole = req.user.role;\r\n            // console.log('current user role: ', currentUserRole);\r\n            let currentResource = resources.filter((item, index) => {\r\n                // console.log('checking item', item.resource);\r\n                return item.resource === requestedPath;\r\n            });\r\n            if(currentResource && currentResource.length > 0) {\r\n                if(currentResource[0].allowedRoles.includes(currentUserRole)) {\r\n                    console.log(\"authorized\");\r\n                    next();\r\n                } else {\r\n                    console.log('not authorized');\r\n                    res.status(401).send('User is not authorized to perform requested operation');    \r\n                }\r\n            }\r\n            else {\r\n                console.log('not found');\r\n                return res.status(404).send(\"Not Found\");\r\n            }\r\n        }\r\n        else {\r\n            console.log('role missing');\r\n            res.status(401).send('User role is missing');\r\n        }    \r\n    } catch (ex) {\r\n            console.log('exception in authorization, token expired:', ex.TokenExpiredError);\r\n            res.status(401).json({message: \"Invalid token.\"});\r\n            // res.status(500).send(\"Invalid token.\");\r\n    }\r\n};\r\n"]}